;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "13.0-25-g6015dbc";},getModuleName:function(){return "prezi_ppt_preload";},getModuleVersion:function(){return "release-2021w06-base-26-gaeb382e";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi_featureswitcher":dependencies[0],"prezi_i18n":dependencies[1],"prezi_logger":dependencies[2],"prezi_plugin_api":dependencies[3],"prezi_plugin_meta":dependencies[4],"prezi_ppt_common":dependencies[5],"prezi_ppt_service":dependencies[6],"prezi_utils":dependencies[7]}};})());};})(arguments);var moduleImpl=(function(){return module(function(c){var f=c.dependencies.prezi_plugin_api,n=c.dependencies.prezi_featureswitcher,g=c.dependencies.prezi_i18n,w=c.dependencies.prezi_logger,q=c.dependencies.prezi_plugin_meta,b=c.dependencies.prezi_ppt_common,v=c.dependencies.prezi_ppt_service,x=c.dependencies.prezi_utils,m={},l=this&&m.__awaiter||function(a,e,b,h){function d(a){return a instanceof b?a:new b(function(e){e(a)})}return new (b||(b=Promise))(function(b,k){function f(a){try{p(h.next(a))}catch(t){k(t)}}function r(a){try{p(h["throw"](a))}catch(t){k(t)}}
function p(a){a.done?b(a.value):d(a.value).then(f,r)}p((h=h.apply(a,e||[])).next())})};Object.defineProperty(m,"__esModule",{value:!0});var d;(function(a){a[a.NOT_STARTED=0]="NOT_STARTED";a[a.DISABLED=1]="DISABLED";a[a.STARTED=2]="STARTED";a[a.HAS_PLAYED_ONCE=3]="HAS_PLAYED_ONCE"})(d=m.VideoState||(m.VideoState={}));class y{constructor(){this.onboardingVideoManager=new z;this.handoverDone=!1;this.PREZI_ID_TIMEOUT=3E4}init(a){this.production=a.serviceOptions.isProduction;this.pptService=v.PptServiceModule.createPptService(a.serviceOptions.hostName,
!this.production);this.pptUploadUtils=b.createPptUploadUtils();this.uiRoot=a.declareUI({uploadProcess:b.IDLE_STATE_COMMON,userSettingsLoaded:!1,pptOnboardingCompleted:!1,videoState:d.NOT_STARTED,preziCreated:!1,initialPopupShown:!1,started:n.isActive("prezioption-pptcreate")},({uploadProcess:a,userSettingsLoaded:r,pptOnboardingCompleted:h,videoState:k},c)=>{if(this.uiRoot.getState().started&&!this.canHandoverToPptInsert()&&(a.state!==b.UploadState.Idle&&a.state!==b.UploadState.InvalidFileExtension||
c.dialog.large((e)=>{let c=[];c.push(e.droparea({text:g.I18n.ts("**Drag and drop** your .ppt file here or upload one from your computer."),illustration:f.IllustrationSmallId.Ppt,filter:{allowPpt:!0},onFileSelected:(e,b)=>l(this,void 0,void 0,function*(){this.uploadToken=`${(new Date).getTime()}`;try{k!==d.DISABLED&&this.onboardingVideoManager.startVideo(()=>this.onVideoPlayed()),yield this.uploadPptFile(b)}catch(B){this.handleUploadError(a)}}),onInvalidFileSelected:(a,e)=>l(this,void 0,void 0,function*(){const a=
Object.assign(Object.assign({},this.uiRoot.getState().uploadProcess),{state:b.UploadState.InvalidFileExtension});this.setUploadProcessState(a);this.pptUploadUtils.logFileExtensionError(a.progress.startTime,a.jobId,e.fileName)}),color:f.ButtonColor.Blue}));r&&!h&&(c.push(e.separator()),c.push(e.button(f.ButtonSize.Small,f.ButtonAlign.Center,(e)=>[e.button({color:f.ButtonColor.Gray,id:"sample_button",content:{text:g.I18n.ts("Use sample .ppt file")},disabled:!1,onClick:()=>l(this,void 0,void 0,function*(){k!==
d.DISABLED&&this.onboardingVideoManager.startVideo(()=>this.onVideoPlayed());this.uploadToken=`${(new Date).getTime()}`;try{yield this.uploadSamplePptFile()}catch(p){this.handleUploadError(a)}})})])));return{id:b.uploadModalId,title:g.I18n.ts("Upload PowerPoint file"),content:c,hideOverlay:k!==d.DISABLED,caution:{text:a.state===b.UploadState.InvalidFileExtension?g.I18n.ts("Unsupported file format. Please try again!"):null,type:f.CautionTypes.Error}}}),a.state===b.UploadState.Uploading||a.state===
b.UploadState.Error||a.state===b.UploadState.UploadFinished&&!this.canHandoverToPptInsert())){const e=a.state;c.dialog.small((h)=>{let c=[];c.push(h.progressBar({id:"pptPreloadProgressbar",title:null!=a?a.fileName:null,titleTooltip:null!=a?a.fileName:null,errorText:a.state===b.UploadState.Error?g.I18n.ts("Failed to upload slides. Please click reload to try again"):null,caption:null==a||null==a.progress.prevPercentage?null:this.pptUploadUtils.calculateProgressMessage(a.progress.remainingTime),percentage:null==
a.progress?100:a.progress.percentage,onCancel:()=>this.handleCancelUpload(),onRestart:()=>this.handleCancelUpload(),control:this.pptUploadUtils.calculateProgressBarControl(e)}));this.production||k!==d.STARTED||c.push(h.button(f.ButtonSize.Small,f.ButtonAlign.Center,(a)=>[a.button({color:f.ButtonColor.Gray,id:"finish_video_button",content:{text:g.I18n.ts("End Video Play")},disabled:!1,onClick:()=>this.onVideoPlayed()})]));return{id:b.uploadModalId,title:g.I18n.ts("Upload PowerPoint slides"),content:c,
hideOverlay:k!==d.DISABLED,align:f.DialogAlign.corner}})}});a.onUserSettingsChange((a)=>{null!=a.JS_EDITOR_PPT_ONBOARDING&&(a=n.isActive("js-force-ppt-onboarding")||!n.isActive("js-disable-ppt-onboarding")&&!a.JS_EDITOR_PPT_ONBOARDING,this._setState({userSettingsLoaded:!0,pptOnboardingCompleted:!a}))});this.uploadTimer=b.createUploadTimer(b.createProgressState(new A(this.uiRoot.getState.bind(this.uiRoot),(a)=>{this._setState(a)})));this.uiRoot.getState().started&&this.start();this.preziIdAvailable=
new Promise((e,b)=>{let c=!1;const d=setTimeout(()=>{c=!0;b()},this.PREZI_ID_TIMEOUT);a.onDocumentEvent((a)=>{null==a||a.kind!==f.DocumentEventKind.Metadata||c||(clearTimeout(d),e(a.preziOid))})});a.onDocumentEvent((a)=>{null!=a&&a.kind===f.DocumentEventKind.Create&&this._setState({preziCreated:!0})})}processMessage(){return l(this,void 0,void 0,function*(){this.uiRoot.getState().started||(this.uiRoot.setState({started:!0}),this.start())})}start(){this.uiRoot.getState().userSettingsLoaded&&!this.uiRoot.getState().pptOnboardingCompleted?
setTimeout(()=>this.uiRoot.dialog.show(b.uploadModalId),0):this.uiRoot.getState().userSettingsLoaded&&this.uiRoot.getState().pptOnboardingCompleted&&this.pluginAccess.send(q.pptInsert,{kind:"requestModalOpen"})}_setState(a){this.uiRoot.setState(a);this.uiRoot.getState().started&&(null!=this.uploadTimer&&this.uploadTimer.isRunning()&&this.canHandoverToPptInsert()&&this.uploadTimer.finish(),this.uiRoot.getState().userSettingsLoaded&&!this.uiRoot.getState().pptOnboardingCompleted&&this.uiRoot.getState().videoState===
d.NOT_STARTED?(this.onboardingVideoManager.initVideo(this.production),this.setVideoState(d.STARTED)):this.uiRoot.getState().userSettingsLoaded&&this.uiRoot.getState().pptOnboardingCompleted&&this.setVideoState(d.DISABLED));this.uiRoot.getState().userSettingsLoaded&&!this.uiRoot.getState().pptOnboardingCompleted?setTimeout(()=>this.uiRoot.dialog.show(b.uploadModalId),0):this.uiRoot.getState().userSettingsLoaded&&this.uiRoot.getState().pptOnboardingCompleted&&!this.uiRoot.getState().initialPopupShown&&
this.uiRoot.getState().started&&(this.pluginAccess.send(q.pptInsert,{kind:"requestModalOpen"}),this.uiRoot.setState({initialPopupShown:!0}))}unload(){this.onboardingVideoManager.removeVideo(!0);null!=this.uploadTimer&&this.uploadTimer.reset();this.uiRoot.dialog.hide(b.uploadModalId)}handleUploadError(a){this.setUploadProcessState(Object.assign(Object.assign({},a),{progress:Object.assign(Object.assign({},this.uiRoot.getState().uploadProcess.progress),{percentage:100,finished:!0}),state:b.UploadState.Error}))}handleCancelUpload(){this.uploadToken=
null;this._setState({uploadProcess:b.IDLE_STATE_COMMON});this.uploadTimer.reset();this.onboardingVideoManager.stopVideo()}handlePptImportFinished(a,b,c){if(b.getState().uploadProcess.jobId===c)switch(a){case "FinishedOk":case "FinishedSlidesFailed":break;case "FinishedStructureFailed":case "Crashed":this.uploadTimer.finish();this.uploadTimer.reset();this.handleUploadError(b.getState().uploadProcess);this.pptUploadUtils.logUploadError(b.getState().uploadProcess.progress.startTime,c,`pptImportFinishedWith: ${a}`);
break;default:x.Utils.assertNever(a)}}uploadPptFile(a){return l(this,void 0,void 0,function*(){const e=a.file,c=yield(()=>l(this,void 0,void 0,function*(){this.pptUploadUtils.logFilePickedForPptUpload(e,a.source);const b=this.uploadToken;this.startUploadProgressMonitorAndState(e.name);const c=yield this.preziIdAvailable,d=yield this.pptService.uploadPpt(c,e,(a)=>{b===this.uploadToken&&this.uploadTimer.updateFileUploadPercentage(a)});if(this.uploadToken!==b)throw Error("Token mismatch");this.setUploadProcessState(Object.assign(Object.assign({},
this.uiRoot.getState().uploadProcess),{jobId:d.importId}));return this.pptService.getPpt(c,d.importId,320)}))();c.fullPptResult.then((a)=>this.handlePptImportFinished(a,this.uiRoot,c.jobId)).catch((a)=>{const b=this.uiRoot.getState().uploadProcess.progress;this.pptUploadUtils.logUploadError(null==b?-1:b.startTime,c.jobId,`Error during handling ppt status: ${a}`)});c.slides.forEach((a)=>l(this,void 0,void 0,function*(){(yield a.slideResult).jobId===this.uiRoot.getState().uploadProcess.jobId&&(this.setUploadProcessState(Object.assign(Object.assign({},
this.uiRoot.getState().uploadProcess),{state:b.UploadState.UploadFinished})),this.handoverToSidebar())}));return null})}startUploadProgressMonitorAndState(a){this.setUploadProcessState(Object.assign(Object.assign({},this.uiRoot.getState().uploadProcess),{state:b.UploadState.Uploading,fileName:a,progress:Object.assign(Object.assign({},b.IDLE_STATE_COMMON.progress),{percentage:0,startTime:(new Date).getTime(),remainingTime:-1})}));this.pptUploadUtils.logUploadStarted(this.uiRoot.getState().uploadProcess.progress.startTime,
this.uiRoot.getState().uploadProcess.jobId);this.uploadTimer.run()}uploadSamplePptFile(){return l(this,void 0,void 0,function*(){this.startUploadProgressMonitorAndState(g.I18n.ts("Loading Sample PPT"));this.pptUploadUtils.logUploadStarted(this.uiRoot.getState().uploadProcess.progress.startTime,this.uiRoot.getState().uploadProcess.jobId);this.setUploadProcessState(Object.assign(Object.assign({},this.uiRoot.getState().uploadProcess),{state:b.UploadState.Uploading,jobId:v.SAMPLE_PPT_JOB_ID,fileName:g.I18n.ts("Loading Sample PPT"),
progress:Object.assign(Object.assign({},this.uiRoot.getState().uploadProcess.progress),{percentage:0,startTime:(new Date).getTime(),remainingTime:-1})}));w.avro.Avro.createDefaultLogger().logUseSamplePpt();const a=this.uploadToken;setTimeout(()=>{a===this.uploadToken&&(this.setUploadProcessState(Object.assign(Object.assign({},this.uiRoot.getState().uploadProcess),{state:b.UploadState.UploadFinished})),this.handoverToSidebar())},2E3);setTimeout(()=>this.uploadTimer.updateFileUploadPercentage(10),300);
setTimeout(()=>this.uploadTimer.updateFileUploadPercentage(40),2500);setTimeout(()=>this.uploadTimer.updateFileUploadPercentage(100),9E3)})}handoverToSidebar(){!this.handoverDone&&this.canHandoverToPptInsert()&&(null!=this.uiRoot.getState().uploadProcess.progress&&(this.handoverDone=!0,this.pluginAccess.send(q.pptInsert,Object.assign(Object.assign({kind:"handover"},this.uiRoot.getState().uploadProcess.progress),{finished:!1,jobId:this.uiRoot.getState().uploadProcess.jobId,fileName:this.uiRoot.getState().uploadProcess.fileName})),
this.uploadTimer.reset()),this.uiRoot.getState().videoState===d.HAS_PLAYED_ONCE&&this.onboardingVideoManager.removeVideo())}setUploadProcessState(a){this.uiRoot.getState().uploadProcess!==a&&this._setState({uploadProcess:a})}setVideoState(a){this.uiRoot.getState().videoState!==a&&this._setState({videoState:a})}canHandoverToPptInsert(){return null!=this.uiRoot&&this.uiRoot.getState().uploadProcess.state===b.UploadState.UploadFinished&&(this.uiRoot.getState().videoState===d.DISABLED||this.uiRoot.getState().videoState===
d.HAS_PLAYED_ONCE)}onVideoPlayed(){this.uiRoot.getState().videoState!==d.HAS_PLAYED_ONCE&&this.setVideoState(d.HAS_PLAYED_ONCE);this.uiRoot.getState().uploadProcess.state===b.UploadState.UploadFinished&&this.handoverToSidebar()}}m.PptPreloadPlugin=y;class A{constructor(a,b){this.getState=a;this.setState=b}getProcess(){return this.getState().uploadProcess}setProcess(a){this.setState({uploadProcess:Object.assign(Object.assign({},this.getState().uploadProcess),a)})}}class z{initVideo(a){const b=window.document.createElement("source");
b.type="video/mp4";b.src=c.getResourceUrl(n.isActive("js-ppt-new-onboarding-video")?"onboarding-video-new.mp4":"onboarding-video.mp4");this.video=window.document.createElement("video");this.video.setAttribute("data-lookup","onboarding-video");this.video.appendChild(b);this.video.crossOrigin="anonymous";this.video.muted=!0;this.videoContainer=window.document.createElement("div");this.videoContainer.setAttribute("style",`position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: black; z-index: 500; opacity: ${a?
"1":"0.9"};`);this.video.setAttribute("style","position: absolute; top: 0; bottom: 0; right: 0; left: 0; margin: auto; max-height: 100%; max-width: 100%; z-index: 500;");a=window.document.createElement("div");a.setAttribute("style","\n\t\t\t\tz-index: 600;\n\t\t\t\tposition: fixed;\n\t\t\t\ttop: 0px;\n\t\t\t\tleft: 0px;\n\t\t\t\twidth: 100%;\n\t\t\t\theight: 100%;\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: center;\n\t\t\t\tpointer-events: auto;\n\t\t\t\tbackground-color: rgba(0, 0, 0, 0.2);\n\t\t\t\tpadding: 40px 0px;\n\t\t\t");
this.videoContainer.appendChild(a);this.videoContainer.appendChild(this.video);this.video.onended=()=>{document.body.contains(this.videoContainer)&&this.video.play()};document.body.appendChild(this.videoContainer)}startVideo(a){this.video.style.transition="opacity 1s";this.video.style.opacity="1";this.video.onpause=a;this.video.play().catch(()=>{})}stopVideo(){null!=this.video&&(this.video.onpause=null,this.video.pause(),this.video.currentTime=0)}removeVideo(a){document.body.contains(this.videoContainer)&&
(a?document.body.removeChild(this.videoContainer):(this.videoContainer.style.transition="opacity 1s;",this.videoContainer.style.opacity="0",((a)=>{setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},1E3)})(this.videoContainer)))}}var u={};Object.defineProperty(u,"__esModule",{value:!0});u.lazyModule={createPlugin(){return new m.PptPreloadPlugin}};return u});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_ppt_preload",["require","prezi_featureswitcher","prezi_i18n","prezi_logger","prezi_plugin_api","prezi_plugin_meta","prezi_ppt_common","prezi_ppt_service","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_ppt_preload.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi_featureswitcher"),require("prezi_i18n"),require("prezi_logger"),require("prezi_plugin_api"),require("prezi_plugin_meta"),require("prezi_ppt_common"),require("prezi_ppt_service"),require("prezi_utils"));}else{this["prezi_ppt_preload"]=__factory(this["prezi_featureswitcher"],this["prezi_i18n"],this["prezi_logger"],this["prezi_plugin_api"],this["prezi_plugin_meta"],this["prezi_ppt_common"],this["prezi_ppt_service"],this["prezi_utils"]);}}).call(this);